// 天气服务类 - 提供获取当前天气和未来天气预报的功能
import 'package:http/http.dart' as http;
import 'dart:convert';
import '../data/weather_model.dart';
import 'weather_cache_manager.dart';

class WeatherService {
  // SoJSON天气API配置
  static const String _baseUrl = 'http://t.weather.itboy.net/api';

  // 获取当前天气数据
  Future<Weather> getCurrentWeather(String cityName) async {
    if (cityName.isEmpty) {
      throw Exception('城市名称不能为空');
    }

    // 检查缓存
    final cachedWeather = weatherCacheManager.getCurrentWeather(cityName);
    if (cachedWeather != null) {
      print(
          'DEBUG: WeatherService: Using cached current weather for $cityName');
      return cachedWeather;
    }

    try {
      // 获取城市ID
      final cityCode = _getCityCode(cityName);
      if (cityCode == null) {
        throw Exception('不支持的城市: $cityName');
      }

      // 获取天气数据
      final data = await _fetchWeatherData(cityName, cityCode);

      final weather = _parseWeatherFromNewSoJson(data);
      // 缓存获取的数据
      weatherCacheManager.setCurrentWeather(cityName, weather);
      return weather;
    } catch (e) {
      print('DEBUG: WeatherService: Error fetching current weather: $e');
      // 重新抛出异常，让调用者处理
      rethrow;
    }
  }

  // 获取天气预报数据
  Future<WeatherForecast> getWeatherForecast(String cityName) async {
    if (cityName.isEmpty) {
      throw Exception('城市名称不能为空');
    }

    // 检查缓存
    final cachedForecast = weatherCacheManager.getWeatherForecast(cityName);
    if (cachedForecast != null) {
      print(
          'DEBUG: WeatherService: Using cached weather forecast for $cityName');
      return cachedForecast;
    }

    try {
      // 获取城市ID
      final cityCode = _getCityCode(cityName);
      if (cityCode == null) {
        throw Exception('不支持的城市: $cityName');
      }

      // 获取天气数据
      final data = await _fetchWeatherData(cityName, cityCode, 'forecast');

      final forecast = _parseWeatherForecastFromNewSoJson(data);
      // 缓存获取的数据
      weatherCacheManager.setWeatherForecast(cityName, forecast);
      return forecast;
    } catch (e) {
      print('DEBUG: WeatherService: Error fetching weather forecast: $e');
      // 重新抛出异常，让调用者处理
      rethrow;
    }
  }

  // 共享的天气数据获取方法
  Future<Map<String, dynamic>> _fetchWeatherData(String cityName, String cityCode, [String type = 'current']) async {
    // 构建API请求URL
    final url = '$_baseUrl/weather/city/$cityCode';
    print(
        'DEBUG: WeatherService: Requesting $type weather for $cityName (ID: $cityCode): $url');

    // 发送HTTP请求
    final response = await http.get(Uri.parse(url));

    // 检查响应状态
    if (response.statusCode == 200) {
      // 解析JSON响应
      final data = jsonDecode(response.body);

      // 检查API返回的状态码
      if (data['status'] != 200) {
        throw Exception('获取天气数据失败: ${data['message']}');
      }

      return data;
    } else {
      throw Exception(
          '获取天气数据失败: 状态码 ${response.statusCode}, 响应: ${response.body}');
    }
  }

  // 一次请求同时获取当前天气和天气预报数据
  Future<(Weather, WeatherForecast)> getWeatherData(String cityName) async {
    if (cityName.isEmpty) {
      throw Exception('城市名称不能为空');
    }

    try {
      // 获取城市ID
      final cityCode = _getCityCode(cityName);
      if (cityCode == null) {
        throw Exception('不支持的城市: $cityName');
      }

      // 进行一次API请求
      final data = await _fetchWeatherData(cityName, cityCode, 'both');

      // 同时解析两类数据
      final weather = _parseWeatherFromNewSoJson(data);
      final forecast = _parseWeatherForecastFromNewSoJson(data);

      // 分别缓存获取的数据
      weatherCacheManager.setCurrentWeather(cityName, weather);
      weatherCacheManager.setWeatherForecast(cityName, forecast);

      return (weather, forecast);
    } catch (e) {
      print('DEBUG: WeatherService: Error fetching combined weather data: $e');
      // 重新抛出异常，让调用者处理
      rethrow;
    }
  }

  // 从SoJSON API响应中解析当前天气数据
  Weather _parseWeatherFromNewSoJson(Map<String, dynamic> data) {
    final cityName = data['cityInfo']['city'] ?? '';
    final tempStr = data['data']['wendu'] ?? '';

    // 使用正则表达式提取数字部分
    final tempMatch = RegExp(r'\d+').firstMatch(tempStr);
    final temperature =
        tempMatch != null ? double.parse(tempMatch.group(0)!) : 0.0;

    final description = data['data']['forecast'][0]['type'] ?? '';
    final tempMinStr = data['data']['forecast'][0]['low'] ?? '';
    final tempMaxStr = data['data']['forecast'][0]['high'] ?? '';

    // 使用正则表达式提取最低温度数字部分
    final tempMinMatch = RegExp(r'\d+').firstMatch(tempMinStr);
    final tempMin =
        tempMinMatch != null ? double.parse(tempMinMatch.group(0)!) : 0.0;

    // 使用正则表达式提取最高温度数字部分
    final tempMaxMatch = RegExp(r'\d+').firstMatch(tempMaxStr);
    final tempMax =
        tempMaxMatch != null ? double.parse(tempMaxMatch.group(0)!) : 0.0;

    // 根据天气描述设置图标代码
    final icon = _getIconCodeFromWeatherType(description);

    return Weather(
      cityName: cityName,
      description: description,
      temperature: temperature,
      tempMin: tempMin,
      tempMax: tempMax,
      icon: icon,
      date: DateTime.now(),
    );
  }

  // 从SoJSON API响应中解析天气预报数据
  WeatherForecast _parseWeatherForecastFromNewSoJson(
      Map<String, dynamic> data) {
    final cityName = data['cityInfo']['city'] ?? '';
    final forecastDays = <ForecastDay>[];

    if (data['data'] != null && data['data']['forecast'] != null) {
      final forecasts = data['data']['forecast'] as List<dynamic>;

      for (var forecast in forecasts) {
        final description = forecast['type'] ?? '';
        final tempMinStr = forecast['low'] ?? '';
        final tempMaxStr = forecast['high'] ?? '';

        // 使用正则表达式提取最低温度数字部分
        final tempMinMatch = RegExp(r'\d+').firstMatch(tempMinStr);
        final tempMin =
            tempMinMatch != null ? double.parse(tempMinMatch.group(0)!) : 0.0;

        // 使用正则表达式提取最高温度数字部分
        final tempMaxMatch = RegExp(r'\d+').firstMatch(tempMaxStr);
        final tempMax =
            tempMaxMatch != null ? double.parse(tempMaxMatch.group(0)!) : 0.0;

        // 根据天气描述设置图标代码
        final icon = _getIconCodeFromWeatherType(description);

        // 解析日期
        DateTime date;
        try {
          final dateStr = forecast['ymd'] ?? '';
          date = DateTime.parse(dateStr);
        } catch (e) {
          date = DateTime.now();
        }

        forecastDays.add(ForecastDay(
          date: date,
          description: description,
          tempMin: tempMin,
          tempMax: tempMax,
          icon: icon,
        ));
      }
    }

    return WeatherForecast(
      cityName: cityName,
      forecastDays: forecastDays,
    );
  }

  // 获取城市ID
  String? _getCityCode(String cityName) {
    // 首先检查精确匹配
    if (_cityIdMap.containsKey(cityName)) {
      return _cityIdMap[cityName];
    }

    // 检查模糊匹配(例如用户输入'天津'，我们有'天津市')
    for (var entry in _cityIdMap.entries) {
      if (entry.key.contains(cityName) || cityName.contains(entry.key)) {
        return entry.value;
      }
    }

    return null;
  }

  // 根据中文天气类型获取对应的图标代码
  String _getIconCodeFromWeatherType(String weatherType) {
    // 根据SoJSON返回的天气类型映射到WeatherUtils期望的图标代码
    final Map<String, String> weatherTypeMap = {
      '晴': '01d',
      '多云': '02d',
      '阴': '03d',
      '阴天': '04d',
      '小雨': '09d',
      '中雨': '10d',
      '大雨': '10d',
      '暴雨': '10d',
      '雷阵雨': '11d',
      '雪': '13d',
      '小雪': '13d',
      '中雪': '13d',
      '大雪': '13d',
      '雾': '50d',
      '霾': '50d',
    };

    return weatherTypeMap[weatherType] ?? '02d'; // 默认返回多云图标
  }

  // SoJSON API目前不需要API密钥，此方法始终返回true
  bool isApiKeyConfigured() {
    return true;
  }

  // 获取所有支持的城市名称列表
  Set<String> getSupportedCities() {
    return _cityIdMap.keys.toSet();
  }

  // 城市ID映射(SoJSON城市编码)
  static const Map<String, String> _cityIdMap = {
    "北京": "101010100",
    "上海": "101020100",
    "天津": "101030100",
    "重庆": "101040100",
    "香港": "101320101",
    "澳门": "101330101",
    "安庆": "101220601",
    "蚌埠": "101220201",
    "巢湖": "101220105",
    "池州": "101221701",
    "滁州": "101221101",
    "阜阳": "101220801",
    "淮北": "101221201",
    "淮南": "101220401",
    "黄山": "101221001",
    "六安": "101221501",
    "马鞍山": "101220501",
    "宿州": "101220701",
    "铜陵": "101221301",
    "芜湖": "101220301",
    "宣城": "101221401",
    "亳州": "101220901",
    "福州": "101230101",
    "龙岩": "101230701",
    "南平": "101230901",
    "宁德": "101230301",
    "莆田": "101230401",
    "泉州": "101230501",
    "三明": "101230801",
    "厦门": "101230201",
    "漳州": "101230601",
    "兰州": "101160101",
    "白银": "101161301",
    "定西": "101160201",
    "嘉峪关": "101161401",
    "金昌": "101160601",
    "酒泉": "101160801",
    "临夏": "101161101",
    "陇南": "101161010",
    "平凉": "101160301",
    "庆阳": "101160401",
    "天水": "101160901",
    "武威": "101160501",
    "张掖": "101160701",
    "广州": "101280101",
    "深圳": "101280601",
    "潮州": "101281501",
    "东莞": "101281601",
    "佛山": "101280800",
    "河源": "101281201",
    "惠州": "101280301",
    "江门": "101281101",
    "揭阳": "101281901",
    "茂名": "101282001",
    "梅州": "101280401",
    "清远": "101281301",
    "汕头": "101280501",
    "汕尾": "101282101",
    "韶关": "101280201",
    "阳江": "101281801",
    "云浮": "101281401",
    "湛江": "101281001",
    "肇庆": "101280901",
    "中山": "101281701",
    "珠海": "101280701",
    "南宁": "101300101",
    "桂林": "101300501",
    "百色": "101301001",
    "北海": "101301301",
    "崇左": "101300201",
    "防城港": "101301401",
    "贵港": "101300801",
    "河池": "101301201",
    "贺州": "101300701",
    "来宾": "101300401",
    "柳州": "101300301",
    "钦州": "101301101",
    "梧州": "101300601",
    "玉林": "101300901",
    "贵阳": "101260101",
    "安顺": "101260301",
    "毕节": "101260701",
    "六盘水": "101260803",
    "黔东南": "101260506",
    "黔南": "101260413",
    "黔西南": "101260906",
    "铜仁": "101260601",
    "遵义": "101260201",
    "海口": "101310101",
    "三亚": "101310201",
    "白沙县": "101310207",
    "保亭县": "101310214",
    "昌江县": "101310206",
    "澄迈县": "101310204",
    "定安县": "101310209",
    "东方": "101310202",
    "乐东县": "101310221",
    "临高县": "101310203",
    "陵水县": "101310216",
    "琼海": "101310211",
    "琼中": "101310208",
    "屯昌县": "101310210",
    "万宁": "101310215",
    "文昌": "101310212",
    "五指山": "101310222",
    "儋州": "101310205",
    "石家庄": "101090101",
    "保定": "101090201",
    "沧州": "101090701",
    "承德": "101090402",
    "邯郸": "101091001",
    "衡水": "101090801",
    "廊坊": "101090601",
    "秦皇岛": "101091101",
    "唐山": "101090501",
    "邢台": "101090901",
    "张家口": "101090301",
    "郑州": "101180101",
    "洛阳": "101180901",
    "开封": "101180801",
    "安阳": "101180201",
    "鹤壁": "101181201",
    "济源": "101181801",
    "焦作": "101181101",
    "南阳": "101180701",
    "平顶山": "101180501",
    "三门峡": "101181701",
    "商丘": "101181001",
    "新乡": "101180301",
    "信阳": "101180601",
    "许昌": "101180401",
    "周口": "101181401",
    "驻马店": "101181601",
    "漯河": "101181501",
    "濮阳": "101181301",
    "哈尔滨": "101050101",
    "大庆": "101050901",
    "大兴安岭": "101050701",
    "鹤岗": "101051201",
    "黑河": "101050601",
    "鸡西": "101051101",
    "佳木斯": "101050401",
    "牡丹江": "101050301",
    "七台河": "101051002",
    "齐齐哈尔": "101050201",
    "双鸭山": "101051301",
    "绥化": "101050501",
    "伊春": "101050801",
    "武汉": "101200101",
    "仙桃": "101201601",
    "鄂州": "101200301",
    "黄冈": "101200501",
    "黄石": "101200601",
    "荆门": "101201401",
    "荆州": "101200801",
    "潜江": "101201701",
    "神农架": "101201201",
    "十堰": "101201101",
    "随州": "101201301",
    "天门": "101201501",
    "咸宁": "101200701",
    "襄阳": "101200201",
    "孝感": "101200401",
    "宜昌": "101200901",
    "恩施": "101201001",
    "长沙": "101250101",
    "张家界": "101251101",
    "常德": "101250601",
    "郴州": "101250501",
    "衡阳": "101250401",
    "怀化": "101251201",
    "娄底": "101250801",
    "邵阳": "101250901",
    "湘潭": "101250201",
    "湘西": "101251509",
    "益阳": "101250700",
    "永州": "101251401",
    "岳阳": "101251001",
    "株洲": "101250301",
    "长春": "101060101",
    "吉林": "101060201",
    "白城": "101060601",
    "白山": "101060901",
    "辽源": "101060701",
    "四平": "101060401",
    "松原": "101060801",
    "通化": "101060501",
    "延边": "101060306",
    "南京": "101190101",
    "苏州": "101190401",
    "无锡": "101190201",
    "常州": "101191101",
    "淮安": "101190901",
    "连云港": "101191001",
    "南通": "101190501",
    "宿迁": "101191301",
    "泰州": "101191201",
    "徐州": "101190801",
    "盐城": "101190701",
    "扬州": "101190601",
    "镇江": "101190301",
    "南昌": "101240101",
    "抚州": "101240401",
    "赣州": "101240701",
    "吉安": "101240601",
    "景德镇": "101240801",
    "九江": "101240201",
    "萍乡": "101240901",
    "上饶": "101240301",
    "新余": "101241001",
    "宜春": "101240501",
    "鹰潭": "101241101",
    "沈阳": "101070101",
    "大连": "101070201",
    "鞍山": "101070301",
    "本溪": "101070501",
    "朝阳": "101071201",
    "丹东": "101070601",
    "抚顺": "101070401",
    "阜新": "101070901",
    "葫芦岛": "101071401",
    "锦州": "101070701",
    "辽阳": "101071001",
    "盘锦": "101071301",
    "铁岭": "101071101",
    "营口": "101070801",
    "呼和浩特": "101080101",
    "阿拉善盟": "101081213",
    "巴彦淖尔": "101080811",
    "包头": "101080201",
    "赤峰": "101080601",
    "鄂尔多斯": "101080701",
    "呼伦贝尔": "101081001",
    "通辽": "101080501",
    "乌海": "101080301",
    "乌兰察布": "101080405",
    "锡林郭勒": "101080902",
    "兴安盟": "101081108",
    "银川": "101170101",
    "固原": "101170401",
    "石嘴山": "101170201",
    "吴忠": "101170301",
    "中卫": "101170501",
    "西宁": "101150101",
    "果洛": "101150507",
    "海北": "101150804",
    "海东": "101150207",
    "共和县": "101150401",
    "德令哈": "101150701",
    "黄南": "101150305",
    "玉树": "101150601",
    "济南": "101120101",
    "青岛": "101120201",
    "滨州": "101121101",
    "德州": "101120401",
    "菏泽": "101121001",
    "济宁": "101120701",
    "莱芜": "101121601",
    "聊城": "101121701",
    "临沂": "101120901",
    "日照": "101121501",
    "泰安": "101120801",
    "威海": "101121301",
    "潍坊": "101120601",
    "烟台": "101120501",
    "枣庄": "101121401",
    "淄博": "101120301",
    "太原": "101100101",
    "长治": "101100501",
    "大同": "101100201",
    "晋城": "101100601",
    "晋中": "101100401",
    "临汾": "101100701",
    "吕梁": "101101100",
    "朔州": "101100901",
    "忻州": "101101001",
    "阳泉": "101100301",
    "运城": "101100801",
    "西安": "101110101",
    "安康": "101110701",
    "宝鸡": "101110901",
    "汉中": "101110801",
    "商洛": "101110601",
    "铜川": "101111001",
    "渭南": "101110501",
    "咸阳": "101110200",
    "延安": "101110300",
    "榆林": "101110401",
    "成都": "101270101",
    "绵阳": "101270401",
    "阿坝": "101271901",
    "巴中": "101270901",
    "达州": "101270601",
    "德阳": "101272001",
    "甘孜": "101271801",
    "广安": "101270801",
    "广元": "101272101",
    "乐山": "101271401",
    "凉山": "101271601",
    "眉山": "101271501",
    "南充": "101270501",
    "内江": "101271201",
    "攀枝花": "101270201",
    "遂宁": "101270701",
    "雅安": "101271701",
    "宜宾": "101271101",
    "资阳": "101271301",
    "自贡": "101270301",
    "泸州": "101271001",
    "拉萨": "101140101",
    "阿里": "101140701",
    "昌都": "101140501",
    "林芝": "101140401",
    "那曲": "101140601",
    "日喀则": "101140201",
    "山南": "101140301",
    "乌鲁木齐": "101130101",
    "阿克苏": "101130801",
    "阿拉尔": "101130701",
    "巴音郭楞": "101130609",
    "博尔塔拉": "101131604",
    "昌吉": "101130401",
    "哈密": "101131201",
    "和田": "101131301",
    "喀什": "101130901",
    "克拉玛依": "101130201",
    "石河子": "101130301",
    "吐鲁番": "101130501",
    "伊犁": "101131012",
    "昆明": "101290101",
    "怒江": "101291201",
    "普洱": "101290901",
    "丽江": "101291401",
    "保山": "101290501",
    "楚雄": "101290801",
    "大理": "101290201",
    "德宏": "101291501",
    "迪庆": "101291305",
    "红河县": "101290301",
    "临沧": "101291101",
    "曲靖": "101290401",
    "文山": "101290601",
    "西双版纳": "101291602",
    "玉溪": "101290701",
    "昭通": "101291001",
    "杭州": "101210101",
    "湖州": "101210201",
    "嘉兴": "101210301",
    "金华": "101210901",
    "丽水": "101210801",
    "宁波": "101210401",
    "绍兴": "101210507",
    "台州": "101210601",
    "温州": "101210701",
    "舟山": "101211101",
    "衢州": "101211001",
    "桐城": "101220609",
    "怀宁县": "101220605",
    "枞阳县": "101221305",
    "潜山县": "101220604",
    "太湖县": "101220603",
    "宿松县": "101220606",
    "望江县": "101220607",
    "岳西县": "101220608",
    "怀远县": "101220202",
    "五河县": "101220204",
    "固镇县": "101220203",
    "庐江县": "101220106",
    "无为县": "101220305",
    "含山县": "101220503",
    "和县": "101220504",
    "东至县": "101221702",
    "石台县": "101221705",
    "青阳县": "101221703",
    "天长": "101221107",
    "明光": "101221103",
    "来安县": "101221106",
    "全椒县": "101221105",
    "定远县": "101221104",
    "凤阳县": "101221102",
    "界首": "101220805",
    "临泉县": "101220804",
    "太和县": "101220806",
    "阜南县": "101220802",
    "颍上县": "101220803",
    "濉溪县": "101221202",
    "歙县": "101221006",
    "休宁县": "101221007",
    "黟县": "101221005",
    "祁门县": "101221004",
    "寿县": "101220408",
    "霍邱县": "101221502",
    "舒城县": "101221507",
    "金寨县": "101221505",
    "霍山县": "101221506",
    "当涂县": "101220502",
    "砀山县": "101220702",
    "萧县": "101220705",
    "灵璧县": "101220703",
    "泗县": "101220704",
    "芜湖县": "101220303",
    "繁昌县": "101220302",
    "南陵县": "101220304",
    "宁国": "101221404",
    "郎溪县": "101221407",
    "广德县": "101221406",
    "泾县": "101221402",
    "绩溪县": "101221405",
    "旌德县": "101221403",
    "涡阳县": "101220902",
    "蒙城县": "101220904",
    "利辛县": "101220903",
    "福清": "101230111",
    "长乐": "101230110",
    "闽侯县": "101230103",
    "连江县": "101230105",
    "罗源县": "101230104",
    "闽清县": "101230102",
    "永泰县": "101230107",
    "平潭县": "101230108",
    "漳平": "101230707",
    "长汀县": "101230702",
    "上杭县": "101230705",
    "武平县": "101230704",
    "连城县": "101230703",
    "邵武": "101230904",
    "武夷山": "101230905",
    "建瓯": "101230910",
    "建阳": "101230907",
    "顺昌县": "101230902",
    "浦城县": "101230906",
    "光泽县": "101230903",
    "松溪县": "101230908",
    "政和县": "101230909",
    "福安": "101230306",
    "福鼎": "101230308",
    "霞浦县": "101230303",
    "古田县": "101230302",
    "屏南县": "101230309",
    "寿宁县": "101230304",
    "周宁县": "101230305",
    "柘荣县": "101230307",
    "仙游县": "101230402",
    "石狮": "101230510",
    "晋江": "101230509",
    "南安": "101230506",
    "惠安县": "101230508",
    "安溪县": "101230502",
    "永春县": "101230504",
    "德化县": "101230505",
    "永安": "101230810",
    "明溪县": "101230807",
    "清流县": "101230803",
    "宁化县": "101230802",
    "大田县": "101230811",
    "尤溪县": "101230809",
    "沙县": "101230808",
    "将乐县": "101230805",
    "泰宁县": "101230804",
    "建宁县": "101230806",
    "龙海": "101230605",
    "云霄县": "101230609",
    "漳浦县": "101230606",
    "诏安县": "101230607",
    "长泰县": "101230602",
    "东山县": "101230608",
    "南靖县": "101230603",
    "平和县": "101230604",
    "华安县": "101230610",
    "皋兰县": "101160102",
    "永登县": "101160103",
    "榆中县": "101160104",
    "会宁县": "101161303",
    "景泰县": "101161305",
    "靖远县": "101161302",
    "临洮县": "101160205",
    "陇西县": "101160203",
    "通渭县": "101160202",
    "渭源县": "101160204",
    "漳县": "101160206",
    "岷县": "101160207",
    "合作": "101161201",
    "临潭县": "101161202",
    "卓尼县": "101161203",
    "舟曲县": "101161204",
    "迭部县": "101161205",
    "玛曲县": "101161206",
    "碌曲县": "101161207",
    "夏河县": "101161208",
    "永昌县": "101160602",
    "玉门": "101160807",
    "敦煌": "101160808",
    "金塔县": "101160803",
    "瓜州县": "101160805",
    "肃北县": "101160806"
  };
}
